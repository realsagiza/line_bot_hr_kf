<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</title>
  <style>
    :root {
      --primary: #2563eb;
      --success: #22c55e;
      --danger: #ef4444;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #dbeafe 0, #f3f4f6 40%, #e5e7eb 100%);
      color: #111827;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.16);
      padding: 24px;
      margin-top: 12px;
    }
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 14px;
      color: #6b7280;
    }
    .amount-display {
      text-align: center;
      padding: 32px 0;
      margin: 24px 0;
      background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
      border-radius: 16px;
    }
    .amount-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .amount-value {
      font-size: 48px;
      font-weight: 700;
      color: var(--primary);
    }
    .amount-unit {
      font-size: 20px;
      color: #6b7280;
      margin-left: 4px;
    }
    .status {
      text-align: center;
      padding: 12px;
      border-radius: 12px;
      margin: 16px 0;
      font-size: 14px;
      font-weight: 600;
    }
    .status-active {
      background: #dcfce7;
      color: #166534;
    }
    .status-completed {
      background: #dbeafe;
      color: #1e40af;
    }
    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }
    .info-section {
      margin: 24px 0;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-size: 14px;
      color: #6b7280;
    }
    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-success {
      background: linear-gradient(135deg, var(--success), #16a34a);
      color: white;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.35);
    }
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
      box-shadow: 0 10px 22px rgba(239, 68, 68, 0.35);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .loading {
      text-align: center;
      padding: 24px;
      color: #6b7280;
    }
    .error {
      text-align: center;
      padding: 16px;
      background: #fee2e2;
      color: #991b1b;
      border-radius: 12px;
      margin: 16px 0;
    }
    .refresh-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 1000;
    }
    .refresh-btn:active {
      transform: scale(0.95);
    }
    .refresh-btn:hover {
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
    }
    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .hidden { display: none; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
  <button class="refresh-btn" id="refresh-btn" onclick="refreshPage()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á cache">
    üîÑ
  </button>
  <div class="app">
    <div class="card">
      <div class="header">
        <div class="title">üí∞ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</div>
        <div class="subtitle">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
      </div>

      <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      <div id="error" class="error hidden"></div>

      <div id="content" class="hidden">
        <div class="amount-display">
          <div class="amount-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å</div>
          <div>
            <span class="amount-value" id="amount-value">0</span>
            <span class="amount-unit">‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>

        <div class="status" id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô...</div>

        <div class="info-section">
          <div class="info-row">
            <span class="info-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span>
            <span class="info-value" id="location">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</span>
            <span class="info-value" id="reason">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠</span>
            <span class="info-value" id="deposit-id">-</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-success" id="btn-end" onclick="endDeposit()">‚úÖ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å</button>
          <button class="btn btn-danger" id="btn-cancel" onclick="cancelDeposit()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let depositId = null;
    let branchBaseUrl = null;
    let sessionId = null;
    let seqNo = null;
    let pollingInterval = null;
    let isEnded = false;

    // ‡∏î‡∏∂‡∏á deposit_id ‡∏à‡∏≤‡∏Å query string
    const urlParams = new URLSearchParams(window.location.search);
    depositId = urlParams.get('deposit_id');

    if (!depositId) {
      showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô');
      return;
    }

    async function init() {
      try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• deposit request (‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô cache)
        const cacheBuster = `?_t=${Date.now()}`;
        const response = await fetch(`/money/api/deposit-info?id=${encodeURIComponent(depositId)}${cacheBuster}`, {
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        });
        const data = await response.json();
        
        if (!response.ok || data.status !== 'ok') {
          throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }

        const depositInfo = data.data;
        branchBaseUrl = depositInfo.branch_base_url;
        sessionId = depositInfo.session_id;
        seqNo = depositInfo.seq_no;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        document.getElementById('location').textContent = depositInfo.location || '-';
        document.getElementById('reason').textContent = depositInfo.reason || '-';
        document.getElementById('deposit-id').textContent = depositId;

        // ‡∏ã‡πà‡∏≠‡∏ô loading, ‡πÅ‡∏™‡∏î‡∏á content
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

        // ‡πÄ‡∏£‡∏¥‡πà‡∏° polling
        startPolling();
      } catch (err) {
        console.error('Init error:', err);
        showError(err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
    }

    function startPolling() {
      // Poll ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      pollAmount();

      // Poll ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      pollingInterval = setInterval(pollAmount, 2000);
    }

    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    async function pollAmount() {
      if (!branchBaseUrl || isEnded) {
        return;
      }

      try {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô cache
        const cacheBuster = `?_t=${Date.now()}`;
        const response = await fetch(`${branchBaseUrl}/socket/latest${cacheBuster}`, {
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        });
        const data = await response.json();

        if (data.success) {
          const amount = data.amount_baht || 0;
          document.getElementById('amount-value').textContent = amount.toLocaleString('th-TH');
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          if (amount > 0) {
            document.getElementById('status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô...';
            document.getElementById('status').className = 'status status-active';
          }
        }
      } catch (err) {
        console.error('Poll error:', err);
        // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      }
    }

    async function endDeposit() {
      if (isEnded) return;

      const btn = document.getElementById('btn-end');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å...';

      try {
        const response = await fetch('/money/api/replenishment-end', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            deposit_id: depositId,
            session_id: sessionId,
            seq_no: seqNo
          })
        });

        const data = await response.json();

        if (!response.ok || data.status !== 'ok') {
          throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÑ‡∏î‡πâ');
        }

        isEnded = true;
        stopPolling();
        
        document.getElementById('status').textContent = '‚úÖ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        document.getElementById('status').className = 'status status-completed';
        document.getElementById('btn-end').disabled = true;
        document.getElementById('btn-cancel').disabled = true;

        // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        setTimeout(() => {
          if (window.liff) {
            window.liff.closeWindow();
          } else {
            window.close();
          }
        }, 3000);
      } catch (err) {
        console.error('End deposit error:', err);
        showError(err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å');
        btn.disabled = false;
        btn.textContent = '‚úÖ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å';
      }
    }

    async function cancelDeposit() {
      if (isEnded) return;

      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô?')) {
        return;
      }

      const btn = document.getElementById('btn-cancel');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...';

      try {
        const response = await fetch('/money/api/replenishment-cancel', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            deposit_id: depositId,
            session_id: sessionId,
            seq_no: seqNo
          })
        });

        const data = await response.json();

        if (!response.ok || data.status !== 'ok') {
          throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÑ‡∏î‡πâ');
        }

        isEnded = true;
        stopPolling();
        
        document.getElementById('status').textContent = '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        document.getElementById('status').className = 'status status-error';
        document.getElementById('btn-end').disabled = true;
        document.getElementById('btn-cancel').disabled = true;

        // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        setTimeout(() => {
          if (window.liff) {
            window.liff.closeWindow();
          } else {
            window.close();
          }
        }, 3000);
      } catch (err) {
        console.error('Cancel deposit error:', err);
        showError(err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
        btn.disabled = false;
        btn.textContent = '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
      }
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').textContent = message;
      document.getElementById('error').classList.remove('hidden');
    }

    function refreshPage() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥';
      
      // ‡∏´‡∏¢‡∏∏‡∏î polling
      stopPolling();
      
      // Clear cache ‡πÅ‡∏•‡∏∞ reload
      // ‡πÉ‡∏ä‡πâ timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
      const url = new URL(window.location.href);
      url.searchParams.set('_t', Date.now().toString());
      
      // ‡∏•‡∏≠‡∏á clear cache ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ
      if ('caches' in window) {
        caches.keys().then(names => {
          names.forEach(name => {
            caches.delete(name);
          });
        });
      }
      
      // Reload ‡∏´‡∏ô‡πâ‡∏≤
      setTimeout(() => {
        window.location.href = url.toString();
      }, 300);
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    window.addEventListener('load', () => {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡πÉ‡∏ô URL ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô cache
      const url = new URL(window.location.href);
      if (!url.searchParams.has('_t')) {
        url.searchParams.set('_t', Date.now().toString());
        // Replace URL ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà reload (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î loop)
        window.history.replaceState({}, '', url.toString());
      }
      init();
    });

    // ‡∏´‡∏¢‡∏∏‡∏î polling ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    window.addEventListener('beforeunload', () => {
      stopPolling();
    });
  </script>
</body>
</html>

